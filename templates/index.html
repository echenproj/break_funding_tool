<!DOCTYPE html>
<html>
<head>
    <title>Quantitative Finance Break-Funding Tool</title>
    <style>
        label { font-weight: bold; display: block; margin-top: 15px; }
        input, select { width: 200px; margin-bottom: 5px; }
        small { color: gray; display: block; }
        .error { color: red; font-weight: bold; margin-top: 20px; }
        #quotes-display {
            display: none;
            background: #f9f9f9;
            border: 1px solid #ccc;
            padding: 10px;
            max-height: 200px;
            overflow: auto;
            white-space: pre-wrap;
            font-family: monospace;
            margin-top: 10px;
            margin-bottom: 15px;
        }
    </style>
</head>

<body>
    <h1>Quantitative Finance Break-Funding Tool</h1>

    {% if error_message %}
        <div class="error">⚠️ {{ error_message }}</div>
    {% endif %}

    <form method="POST" enctype="multipart/form-data">
        {% if loading %}
        <div style="margin: 10px 0; font-weight: bold; color: #555;">
            ⏳ Extracting data from PDF, please wait...
        </div>
        {% endif %}

        <!-- Upload -->
        <label for="pdf">Upload Term Sheet (PDF):</label>
        <input type="file" name="pdf" accept=".pdf"><br><br>

        <!-- Upload button to show extracted quotes -->
        <button type="submit" name="action" value="upload" onclick="disableRequiredFields()">Upload</button>

        <!-- Effective Date -->
        <label for="effective_date">Effective Date:</label>
        <input type="date" id="effective_date" name="effective_date" value="{{ effective_date }}" required>
        <small>{{ extracted_quotes.effective_date or '' }}</small>

        <!-- Maturity Date -->
        <label for="maturity_date">Maturity Date:</label>
        <input type="date" name="maturity_date" value="{{ maturity_date }}" required>
        <small>{{ extracted_quotes.maturity_date or '' }}</small>

        <!-- Frequency -->
        <label for="frequency">Frequency:</label>
        <select name="frequency" required>
            {% for f in ['monthly', 'quarterly', 'semiannual', 'annual'] %}
                <option value="{{ f }}" {% if frequency == f %}selected{% endif %}>{{ f.capitalize() }}</option>
            {% endfor %}
        </select>
        <small>{{ extracted_quotes.frequency or '' }}</small>

        <!-- Amortization Type -->
        <label for="amortization_type">Amortization Type:</label>
        <select name="amortization_type" required>
            {% for t in ['interest only', 'equal', 'linear', 'custom'] %}
                <option value="{{ t }}" {% if amortization_type == t %}selected{% endif %}>{{ t.capitalize() }}</option>
            {% endfor %}
        </select>
        <small>{{ extracted_quotes.amortization_type or '' }}</small>

        <!-- Loan Rate -->
        <label for="loan_rate">Loan Rate (%):</label>
        <input type="number" step="0.01" name="loan_rate" value="{{ loan_rate }}" required>
        <small>{{ extracted_quotes.loan_rate or '' }}</small>

        <!-- Balance -->
        <label for="balance">Balance:</label>
        <input type="number" step="0.01" id="balance" name="balance" value="{{ balance }}" required>
        <small>{{ extracted_quotes.balance or '' }}</small>

        <!-- Prepayment Date -->
        <label for="prepayment_date">Prepayment Date:</label>
        <input type="date" id="prepayment_date" name="prepayment_date" value="{{ prepayment_date or '' }}" required>

        <!-- Prepayment Amount -->
        <label for="prepayment_amount">Prepayment Amount:</label>
        <input type="number" step="0.01" id="prepayment_amount" name="prepayment_amount" value="{{ prepayment_amount or '' }}" required>


        <br><br>
        <button type="submit" name="action" value="calculate">Calculate</button>
    </form>

    <form method="POST" action="/download_ppt" style="margin-top: 20px;">
        <!-- Include hidden inputs to pass data to backend -->
        <input type="hidden" name="effective_date" value="{{ effective_date }}">
        <input type="hidden" name="maturity_date" value="{{ maturity_date }}">
        <input type="hidden" name="loan_rate" value="{{ loan_rate }}">
        <input type="hidden" name="balance" value="{{ balance }}">
        <input type="hidden" name="break_funding_cost" value="{{ break_funding_cost or '' }}">
        <button type="submit">Download PowerPoint Slide</button>
    </form>
    
    {% if break_funding_cost is not none %}
        <h3>Break Funding Cost</h3>
        <p style="font-size: 1.25em; font-weight: bold;">
            ${{ "%.2f"|format(break_funding_cost) }}
        </p>
    {% endif %}

    {% if plot_generated %}
        <h2>Cashflow Plot</h2>
        <img src="{{ url_for('static', filename='plot.png') }}" alt="Cashflow Plot">
    {% endif %}
    
    
    <script>
        function disableRequiredFields() {
            const requiredFields = document.querySelectorAll("[required]");
            requiredFields.forEach(field => field.removeAttribute("required"));
        }
    </script>

</body>
</html>